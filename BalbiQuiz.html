<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BalbiQuiz - HVAC (Wallet + Claim 4h)</title>

  <!-- Ethers: use UMA das linhas abaixo -->
  <!-- 1) CDN (padrão). Se seu host bloquear, use a opção 2 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <!-- 2) LOCAL (baixe ethers-5.7.2.umd.min.js para a mesma pasta e descomente a linha abaixo) -->
  <!-- <script src="./ethers-5.7.2.umd.min.js"></script>  TROCAR AQUI SE USAR ARQUIVO LOCAL -->

  <!-- Opcional: utilitários da faucet (se expor window.BalbiFaucet.sendReward) -->
  <script>
    (function(){
      const s=document.createElement('script');
      s.src='faucet-frontend.js?v='+Date.now();
      s.defer=true;
      s.onerror = () => console.warn('[Quiz] faucet-frontend.js não carregou (opcional).');
      document.head.appendChild(s);
    })();
  </script>

  <style>
    :root{ --blue-glow:#31a8ff; --blue-glow-2:#7cc2ff; --old-glow:#00ffcc; --old-sec:#ff00cc; --bg:#0a0a0a; --text:#fff; --card:rgba(255,255,255,.05); --anim:.5s; }
    *{margin:0;padding:0;box-sizing:border-box;font-family:Arial,Helvetica,sans-serif}
    body{ min-height:100vh; display:flex; align-items:center; justify-content:center; color:var(--text);
      background:linear-gradient(45deg,var(--bg),#0f1724); perspective:1000px; overflow:hidden; position:relative; }
    body::before{ content:''; position:absolute; width:200%; height:200%; top:-50%; left:-50%;
      background:conic-gradient(from 0deg, transparent, var(--blue-glow), transparent);
      animation:rot 15s linear infinite; opacity:.12; z-index:-2; }
    @keyframes rot{to{transform:rotate(360deg)}}
    body::after{ content:''; position:fixed; width:140px; height:122px; top:10vh; left:5vw; border:2px solid rgba(125,190,255,.35);
      clip-path:polygon(25% 6.7%,75% 6.7%,100% 50%,75% 93.3%,25% 93.3%,0% 50%); box-shadow:0 0 12px rgba(49,168,255,.45), inset 0 0 18px rgba(124,194,255,.25);
      animation:walk 18s ease-in-out infinite alternate, pulse 4s ease-in-out infinite; z-index:-1; pointer-events:none; }
    @keyframes walk{ 0%{transform:translate(0,0) rotate(0)} 22%{transform:translate(65vw,10vh) rotate(30deg)}
      44%{transform:translate(30vw,55vh) rotate(80deg)} 66%{transform:translate(75vw,65vh) rotate(140deg)}
      88%{transform:translate(10vw,70vh) rotate(210deg)} 100%{transform:translate(0,0) rotate(260deg)} }
    @keyframes pulse{0%,100%{opacity:.22}50%{opacity:.42}}
    .container{ width:90%; max-width:800px; padding:20px; text-align:center; position:relative;
      min-height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center; }
    #welcome, .question-card, #result{display:none}
    #welcome{display:flex; flex-direction:column; gap:12px; align-items:center}
    .logo{font-size:3em; text-shadow:0 0 10px var(--blue-glow),0 0 20px var(--blue-glow-2); animation:fl 4s ease-in-out infinite}
    @keyframes fl{50%{transform:translateY(-16px)}}
    .subtitle{opacity:.9; max-width:680px}
    .pk-wrap{width:min(560px,94vw); display:flex; gap:8px; flex-wrap:wrap; justify-content:center}
    #privateKey{ flex:1 1 360px; padding:12px 14px; font-size:14px; color:#d9ecff;
      background:rgba(255,255,255,.06); border:1px solid rgba(61,106,196,.5); border-radius:12px; outline:none; }
    #privateKey::placeholder{color:#c7d6f0aa}
    button{ padding:14px 26px; font-size:1.05em; margin:6px; background:linear-gradient(45deg,var(--old-glow),var(--old-sec));
      color:#fff; border:none; border-radius:10px; cursor:pointer; position:relative; overflow:hidden; transition:transform var(--anim) ease, box-shadow var(--anim) ease; }
    button:hover{ transform:scale(1.08); box-shadow:0 0 30px var(--old-glow), 0 0 50px var(--old-sec) }
    button::before{ content:''; position:absolute; inset:0; transform:translateX(-100%);
      background:linear-gradient(90deg,transparent,rgba(255,255,255,.4),transparent); animation:shine 2s linear infinite; }
    @keyframes shine{to{transform:translateX(100%)}}
    .sound{font-size:.8em; padding:6px 12px; border-radius:16px}
    .question-card{ background:var(--card); border:2px solid var(--old-glow); border-radius:15px; padding:26px; margin:20px 0;
      box-shadow:0 0 20px var(--old-glow); animation:pc 2s ease-in-out infinite; }
    @keyframes pc{50%{transform:scale(1.02)}}
    .question-card h2{font-size:1.8em; margin-bottom:16px; text-shadow:0 0 10px var(--old-glow)}
    .question-card p{font-size:1.1em; margin-bottom:18px}
    .hint{display:none; font-style:italic; color:#cfe6ff}
    #result .score{font-size:2.35em; text-shadow:0 0 20px var(--old-glow); margin:6px 0 2px}
    .pass-fail{font-size:1.6em; margin:10px 0 8px}
    .wallet{margin-top:4px; font-size:.95em; word-break:break-all; opacity:.95}
    .reward{margin-top:6px; font-size:1.05em}
    .round-info{margin-top:4px; opacity:.9}
    .send-area{margin-top:12px}
    .timer{margin-top:6px; color:#8ec7ff}
    @keyframes fadeOutUp{to{opacity:0;transform:translateY(-40px)}}
    @keyframes fadeInDown{from{opacity:0;transform:translateY(-40px)}to{opacity:1;transform:none}}
    @media (max-width:600px){ .logo{font-size:2.2em} button{padding:10px 18px; font-size:1em} .question-card h2{font-size:1.5em} .question-card p{font-size:1em} }
    .diag{margin-top:6px; font-size:.85em; opacity:.9}
  </style>
</head>
<body>
  <div class="container">
    <!-- ENTRADA -->
    <section id="welcome" aria-label="Bem-vindo">
      <h1 class="logo">BalbiQuiz</h1>
      <p class="subtitle">
        Digite sua <strong>Private Key</strong> (processada só no seu navegador) e toque em <em>Iniciar Jogo</em>.
        No final, exibimos sua <strong>carteira</strong> e o <strong>Claim BALBI</strong> de acordo com a pontuação acumulada.
      </p>
      <div class="pk-wrap">
        <input id="privateKey" type="password" placeholder="Private Key (0x... 64 hex)" autocapitalize="off" spellcheck="false" autocomplete="off">
        <button id="soundToggle" class="sound" aria-pressed="true">som: liga</button>
        <button id="startBtn">Iniciar Jogo</button>
      </div>
      <small style="opacity:.75">Sua chave <u>não é salva</u> nem enviada para nenhum servidor.</small>
      <div id="diag" class="diag"></div>
    </section>

    <!-- PERGUNTAS (5 por rodada) -->
    <div id="question1" class="question-card">
      <h2 id="title1"></h2><p id="text1"></p><p>Escolha a decisão:</p>
      <button id="opt1a" data-q="1" data-k="a"></button>
      <button id="opt1b" data-q="1" data-k="b"></button>
      <button id="opt1c" data-q="1" data-k="c"></button>
      <button class="hintBtn" data-h="1">Pedir Dica</button>
      <p id="hint1" class="hint"></p>
    </div>
    <div id="question2" class="question-card">
      <h2 id="title2"></h2><p id="text2"></p><p>Escolha a decisão:</p>
      <button id="opt2a" data-q="2" data-k="a"></button>
      <button id="opt2b" data-q="2" data-k="b"></button>
      <button id="opt2c" data-q="2" data-k="c"></button>
      <button class="hintBtn" data-h="2">Pedir Dica</button>
      <p id="hint2" class="hint"></p>
    </div>
    <div id="question3" class="question-card">
      <h2 id="title3"></h2><p id="text3"></p><p>Escolha a decisão:</p>
      <button id="opt3a" data-q="3" data-k="a"></button>
      <button id="opt3b" data-q="3" data-k="b"></button>
      <button id="opt3c" data-q="3" data-k="c"></button>
      <button class="hintBtn" data-h="3">Pedir Dica</button>
      <p id="hint3" class="hint"></p>
    </div>
    <div id="question4" class="question-card">
      <h2 id="title4"></h2><p id="text4"></p><p>Escolha a decisão:</p>
      <button id="opt4a" data-q="4" data-k="a"></button>
      <button id="opt4b" data-q="4" data-k="b"></button>
      <button id="opt4c" data-q="4" data-k="c"></button>
      <button class="hintBtn" data-h="4">Pedir Dica</button>
      <p id="hint4" class="hint"></p>
    </div>
    <div id="question5" class="question-card">
      <h2 id="title5"></h2><p id="text5"></p><p>Escolha a decisão:</p>
      <button id="opt5a" data-q="5" data-k="a"></button>
      <button id="opt5b" data-q="5" data-k="b"></button>
      <button id="opt5c" data-q="5" data-k="c"></button>
      <button class="hintBtn" data-h="5">Pedir Dica</button>
      <p id="hint5" class="hint"></p>
    </div>

    <!-- RESULTADO -->
    <section id="result" aria-live="polite">
      <h2>Resultado Final do BalbiQuiz</h2>
      <p id="scoreText" class="score">Pontuação: 0/100</p>
      <p id="passFail" class="pass-fail"></p>
      <div class="wallet"><strong>Wallet:</strong> <span id="walletAddr">—</span></div>
      <div class="reward"><strong>Acumulado nesta janela:</strong> <span id="rewardVal">0.0 BALBI</span></div>
      <div class="round-info"><span id="roundsInfo">Rodadas nesta janela: 0/3</span></div>
      <div class="send-area">
        <button id="claimButton" disabled>Claim 0.0 BALBI</button>
        <div id="claimTimer" class="timer"></div>
        <div id="sendMsg" style="margin-top:6px; font-size:.95em; opacity:.9"></div>
      </div>
      <div id="answerKey" style="margin-top:10px; text-align:left; font-size:.9em; opacity:.95"></div>
      <button id="restartBtn">Jogar Novamente</button>
    </section>
  </div>

  <script>
    /* ====== DIAGNÓSTICO RÁPIDO ====== */
    const diagEl = document.getElementById('diag');
    function setDiag(msg){ diagEl.textContent = msg; }

    /* ====== State (nada de salvar PK) ====== */
    const LS_ADDR_KEY = 'balbi_wallet_addr';
    const LS_WINDOW_START = 'balbi_quiz_window_start';
    const LS_ROUNDS_USED  = 'balbi_quiz_rounds_used';
    const LS_PENDING      = 'balbi_quiz_pending';
    const LS_LAST_CLAIM   = 'balbi_quiz_last_claim';
    const WINDOW_MS = 4*60*60*1000, CLAIM_COOLDOWN_MS=4*60*60*1000, MAX_ROUNDS=3;

    let audioCtx=null, soundOn=true;
    function ensureAudio(){ if(!audioCtx){ try{ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); }catch(e){} } }
    function beep(freq=520, dur=.12){ if(!soundOn) return;
      try{ ensureAudio(); if(!audioCtx) return;
        const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type="sine"; o.frequency.value=freq; o.connect(g); g.connect(audioCtx.destination);
        const t0=audioCtx.currentTime; g.gain.setValueAtTime(.001,t0); g.gain.exponentialRampToValueAtTime(.16,t0+.02);
        g.gain.exponentialRampToValueAtTime(.001,t0+dur); o.start(t0); o.stop(t0+dur+.02);
      }catch(e){} }

    const now=()=>Date.now();
    const readInt=(k,d=0)=>{const v=localStorage.getItem(k), n=v==null?NaN:Number(v); return Number.isFinite(n)?n:d;};
    const readFloat=(k,d=0)=>{const v=localStorage.getItem(k), n=v==null?NaN:parseFloat(v); return Number.isFinite(n)?n:d;};
    function startNewWindow(){ localStorage.setItem(LS_WINDOW_START,String(now())); localStorage.setItem(LS_ROUNDS_USED,'0'); localStorage.setItem(LS_PENDING,'0'); }
    function ensureWindow(){ const ws=readInt(LS_WINDOW_START,0); if(!ws||now()-ws>=WINDOW_MS){ startNewWindow(); } }
    function roundsUsed(){ ensureWindow(); return readInt(LS_ROUNDS_USED,0); }
    function pendingAmount(){ ensureWindow(); return Number(readFloat(LS_PENDING,0).toFixed(1)); }
    function addRoundAndReward(reward){ ensureWindow(); const used=Math.min(MAX_ROUNDS, roundsUsed()+1);
      localStorage.setItem(LS_ROUNDS_USED,String(used)); const next=Math.max(0,(pendingAmount()+(reward||0))); localStorage.setItem(LS_PENDING,next.toFixed(1)); }
    function canStartRound(){ ensureWindow(); return roundsUsed()<MAX_ROUNDS; }
    function resetIfWindowExpired(){ const ws=readInt(LS_WINDOW_START,0); if(!ws||now()-ws>=WINDOW_MS){ startNewWindow(); } }
    function claimCooldownRemaining(){ const last=readInt(LS_LAST_CLAIM,0); if(!last) return 0; return Math.max(0, CLAIM_COOLDOWN_MS-(now()-last)); }
    function formatMs(ms){ const s=Math.ceil(ms/1000), h=Math.floor(s/3600), m=Math.floor((s%3600)/60), ss=s%60; return [h,m,ss].map(n=>String(n).padStart(2,'0')).join(':'); }

    const QUESTIONS=[]; const baseQ=[ /* (mesmas perguntas que te enviei antes) */ 
      {text:"Edifício comercial com ar abafado e odores persistentes. Ventilação mínima.",
       correct:"Elevar a ventilação externa e balancear o sistema para atender critérios adequados de IAQ.",
       wrong1:"Reduzir a renovação de ar para cortar consumo, mantendo o status atual.",
       wrong2:"Aplicar um critério de segurança de refrigerantes para decidir taxas mínimas de ventilação.",
       hint:"Ventilação adequada é determinante para IAQ."},
      {text:"Hospital com mofo por umidade alta; HVAC não controla UR.",
       correct:"Desumidificar e manter UR < 60% com controle dedicado no suprimento.",
       wrong1:"Elevar apenas o setpoint de temperatura e ignorar a UR.",
       wrong2:"Usar requisitos de eficiência energética para fixar um ponto de UR em área crítica.",
       hint:"Mofo = UR alta; trate a umidade diretamente."},
      {text:"Dutos superdimensionados geram distribuição irregular e ruídos.",
       correct:"Redimensionar dutos por método consagrado (p.ex., estática recuperada/SMACNA) e reequilibrar.",
       wrong1:"Instalar mais ventiladores em série sem revisar dutos.",
       wrong2:"Usar norma elétrica para definir bitola de duto de ar.",
       hint:"Métodos de dutos resolvem raiz do problema."},
      {text:"Escolha de refrigerante; opções incluem GWP alto.",
       correct:"Priorizar fluido de baixo GWP considerando segurança, eficiência e compatibilidades.",
       wrong1:"Escolher o maior GWP pelo menor CAPEX.",
       wrong2:"Usar um procedimento de ventilação de ocupação para aprovar refrigerante.",
       hint:"Sustentabilidade e conformidade contam."},
      {text:"Prédio alto com infiltração de ar externo indesejada.",
       correct:"Ajustar pressões para leve positivo em zonas limpas e melhorar estanqueidade.",
       wrong1:"Vedar janelas com fita sem revisar setpoints e balanceamento.",
       wrong2:"Definir pressões com base em limites de conforto térmico apenas.",
       hint:"Relação de pressão entre zonas é chave."},
      {text:"Data center com hotspot em racks por má distribuição.",
       correct:"Conter corredores quente/frio e otimizar percursos de ar, com vedação de vazios.",
       wrong1:"Aumentar rotação dos ventiladores apenas.",
       wrong2:"Usar requisitos de segurança de refrigerantes para layout de TI.",
       hint:"Fluxo organizado evita superaquecimento."},
      {text:"Escritório com desconforto por variações entre zonas.",
       correct:"Controle por zonas (p.ex., VAV comissionado) e difusão adequada.",
       wrong1:"Aumentar potência da máquina central para todo o andar.",
       wrong2:"Fixar um único sensor de retorno como referência de todo o pavimento.",
       hint:"Mais controle local = mais conforto."},
      {text:"Escola com filtros de baixa eficiência e IAQ comprometida.",
       correct:"Adotar MERV mais alto (p.ex., 13) e garantir vedação/assentamento corretos.",
       wrong1:"Diminuir a eficiência de filtragem para reduzir queda de pressão.",
       wrong2:"Usar um padrão de classificação de segurança de fluidos para definir MERV.",
       hint:"Filtragem adequada reduz partículas."},
      {text:"Vazamentos recorrentes de refrigerante em sistema industrial.",
       correct:"Programa de manutenção com detecção de vazamentos, registros e eliminação da causa.",
       wrong1:"Repor fluido periodicamente e seguir operando.",
       wrong2:"Aplicar critérios de ventilação mínima para definir vazamento aceitável.",
       hint:"Vazamento não é rotina: investigue."},
      {text:"Teatro com ruído de HVAC impactando a acústica.",
       correct:"Silenciadores em dutos, difusão adequada e velocidades controladas.",
       wrong1:"Elevar o fluxo para 'mascarar' ruído.",
       wrong2:"Usar um padrão residencial para metas acústicas de teatro.",
       hint:"Tratamento acústico no duto ajuda muito."}
      /* ... (mantive compacta; pode manter a lista completa do arquivo anterior) */
    ];
    baseQ.forEach(q=>QUESTIONS.push(q));

    let currentQuestion=0, score=0, hintsUsed=[false,false,false,false,false];
    let selectedQuestions=[], answersMap={}, chosen={}, shownText={}, correctShown={};
    let walletAddress=null;

    const normRefs=["ASHRAE 62.1-2019 §6.2","ASHRAE 55-2020 §5.3","ASHRAE 90.1-2019 §6.5","ASHRAE 15-2019 §8","ASHRAE TC 9.9","NBR 16401-3 §7","NBR 15220-3 §5","IEC 60079-13 §5.5"];
    const shuffle = arr => arr.map(v=>({v,r:Math.random()})).sort((a,b)=>a.r-b.r).map(e=>e.v);
    const ref = t => Math.random()<.5 ? `${t} — Ref: ${normRefs[Math.floor(Math.random()*normRefs.length)]}` : t;
    const isValidPrivateKey = v => /^0x[0-9a-fA-F]{64}$/.test((v||'').trim());
    function computeReward(points){ if(points<60) return 0; return Math.floor(points/10)/10; } // 60->0.6 ... 100->1.0

    const welcome = document.getElementById('welcome');
    const startBtn = document.getElementById('startBtn');
    const pkInput  = document.getElementById('privateKey');
    const claimBtn   = document.getElementById('claimButton');
    const claimTimer = document.getElementById('claimTimer');
    const sendMsg    = document.getElementById('sendMsg');
    const soundBtn=document.getElementById('soundToggle');
    soundBtn.addEventListener('click',()=>{soundOn=!soundOn; soundBtn.textContent=soundOn?"som: liga":"som: desliga"; soundBtn.setAttribute('aria-pressed', soundOn?'true':'false');});
    document.getElementById('restartBtn').addEventListener('click', ()=>location.reload());

    document.body.addEventListener('click', (e)=>{
      const el = e.target;
      if (el.matches('button[data-q][data-k]')) {
        const n = Number(el.getAttribute('data-q')), k = el.getAttribute('data-k');
        handleSelectAnswer(n,k);
      } else if (el.matches('.hintBtn')) {
        const h = Number(el.getAttribute('data-h'));
        if(!hintsUsed[h-1]){ document.getElementById('hint'+h).style.display='block'; hintsUsed[h-1]=true; beep(580,.12); }
        else alert('Você já usou sua dica para esta pergunta!');
      }
    });

    function selectRandomQuestions(){
      const idx=[...Array(QUESTIONS.length).keys()];
      selectedQuestions=[]; for(let i=0;i<5;i++){ selectedQuestions.push(idx.splice(Math.floor(Math.random()*idx.length),1)[0]); }
    }
    function setupQuestions(){
      answersMap={}; shownText={}; correctShown={}; currentQuestion=0; score=0; hintsUsed=[false,false,false,false,false];
      for(let i=0;i<5;i++){
        const n=i+1; const q=QUESTIONS[selectedQuestions[i]];
        document.getElementById(`title${n}`).innerText=`Situação ${n}`;
        document.getElementById(`text${n}`).innerText=q.text;
        document.getElementById(`hint${n}`).innerText=q.hint||"";
        const opts=[{k:'a',t:q.correct,ok:true},{k:'b',t:q.wrong1,ok:false},{k:'c',t:q.wrong2,ok:false}].map(o=>({...o,t:ref(o.t)}));
        const s=shuffle(opts); answersMap[n]={}; shownText[n]={a:'',b:'',c:''}; let corr='';
        ['a','b','c'].forEach((k,i2)=>{ document.getElementById(`opt${n}${k}`).innerText=s[i2].t;
          answersMap[n][k]=s[i2].ok; shownText[n][k]=s[i2].t; if(s[i2].ok) corr=s[i2].t; });
        correctShown[n]=corr;
      }
    }
    function showCard(n, show=true){
      const el=document.getElementById('question'+n);
      el.style.display = show ? 'block' : 'none';
      el.style.animation = show ? 'fadeInDown .5s ease' : 'fadeOutUp .5s ease';
      if (!show){ setTimeout(()=>{ el.style.animation=''; }, 500); }
    }
    function nextQuestion(){
      currentQuestion++;
      if(currentQuestion<=5){ showCard(currentQuestion,true); } else { showResult(); }
    }
    function handleSelectAnswer(n,k){
      const ok=!!(answersMap[n]&&answersMap[n][k]);
      chosen[n]={key:k,text:shownText[n][k],correct:ok}; if(ok) score+=20;
      beep(620,.14); showCard(n,false); setTimeout(nextQuestion, 500);
    }
    fun