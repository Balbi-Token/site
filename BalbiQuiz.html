<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BalbiQuiz - Mini RPG de HVAC</title>
    <style>
        :root {
            --glow-color: #00ffcc;
            --secondary-glow: #ff00cc;
            --animation-speed: 0.5s;
            --bg-color: #0a0a0a;
            --text-color: #fff;
            --card-bg: rgba(255, 255, 255, 0.05);
            --border-color: var(--glow-color);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Arial', sans-serif; }
        body {
            background: linear-gradient(45deg, var(--bg-color), #1a1a1a);
            color: var(--text-color);
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; perspective: 1000px; overflow: hidden; position: relative;
        }
        body::before {
            content: ''; position: absolute; width: 200%; height: 200%;
            background: conic-gradient(from 0deg, transparent, var(--glow-color), transparent);
            top: -50%; left: -50%; animation: rotate-bg 15s linear infinite; opacity: 0.15; z-index: -1;
        }
        @keyframes rotate-bg { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .container {
            max-width: 800px; width: 90%; padding: 20px; text-align: center; transform-style: preserve-3d; position: relative;
            min-height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        #welcome, .question-card, #result { display: none; transform-style: preserve-3d; }
        #welcome { display: flex; flex-direction: column; align-items: center; gap: 12px; }
        .logo {
            font-size: 3em; text-shadow: 0 0 10px var(--glow-color), 0 0 20px var(--secondary-glow);
            animation: text-glow 1.5s infinite alternate, float 4s ease-in-out infinite; transform-style: preserve-3d;
        }
        .logo::before {
            content: 'BalbiQuiz'; position: absolute; top: 0; left: 0; color: transparent;
            text-shadow: 0 0 20px var(--glow-color); animation: glitch 2s infinite;
        }
        @keyframes glitch { 0% { clip: rect(0, auto, auto, 0); } 5% { clip: rect(10px, auto, auto, 0); transform: skew(0.5deg); }
            10% { clip: rect(20px, auto, auto, 0); transform: skew(-0.5deg); } 100% { clip: rect(0, auto, auto, 0); } }
        @keyframes text-glow { 0% { text-shadow: 0 0 10px var(--glow-color); }
            100% { text-shadow: 0 0 20px var(--glow-color), 0 0 30px var(--secondary-glow); } }
        @keyframes float { 0%, 100% { transform: translateY(0) rotateX(0deg) rotateY(0deg); }
            50% { transform: translateY(-20px) rotateX(10deg) rotateY(5deg); } }
        button {
            padding: 15px 30px; font-size: 1.2em;
            background: linear-gradient(45deg, var(--glow-color), var(--secondary-glow));
            border: none; border-radius: 10px; color: var(--text-color); cursor: pointer;
            position: relative; overflow: hidden; transform-style: preserve-3d;
            transition: transform var(--animation-speed) ease, box-shadow var(--animation-speed) ease; margin: 10px;
        }
        button:hover { transform: scale(1.1) rotateX(10deg) rotateY(5deg);
            box-shadow: 0 0 30px var(--glow-color), 0 0 50px var(--secondary-glow); }
        button::before {
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: shine 2s infinite linear;
        }
        @keyframes shine { 0% { left: -100%; } 100% { left: 100%; } }
        .question-card {
            background: var(--card-bg); border: 2px solid var(--border-color); border-radius: 15px;
            padding: 30px; margin: 20px 0; box-shadow: 0 0 20px var(--glow-color);
            transform: rotateY(5deg); transition: transform var(--animation-speed) ease;
            animation: pulse-card 2s infinite ease-in-out;
        }
        .question-card:hover { transform: rotateY(0deg) scale(1.05);
            box-shadow: 0 0 40px var(--glow-color), 0 0 60px var(--secondary-glow); }
        @keyframes pulse-card { 0%, 100% { transform: rotateY(5deg) scale(1); } 50% { transform: rotateY(5deg) scale(1.02); } }
        .question-card h2 { font-size: 1.8em; margin-bottom: 20px; text-shadow: 0 0 10px var(--glow-color); }
        .question-card p { font-size: 1.2em; margin-bottom: 20px; }
        .hint { font-style: italic; color: #ccc; margin-top: 10px; display: none; }
        #result { transform-style: preserve-3d; }
        .score { font-size: 3em; text-shadow: 0 0 20px var(--glow-color); animation: score-pop 1s ease-out, text-glow 1.5s infinite alternate; }
        @keyframes score-pop { 0% { transform: scale(0.5) rotateX(-90deg); opacity: 0; } 100% { transform: scale(1) rotateX(0deg); opacity: 1; } }
        .pass-fail { font-size: 2em; margin: 20px 0; animation: float 4s ease-in-out infinite; }
        .footer { position: absolute; bottom: 10px; width: 100%; text-align: center; font-size: 0.9em; color: #ccc; text-shadow: 0 0 5px var(--glow-color); }
        @keyframes fadeOutUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-50px); } }
        @keyframes fadeInDown { 0% { opacity: 0; transform: translateY(-50px); } 100% { opacity: 1; transform: translateY(0); } }
        /* Gabarito */
        #answerKey { margin-top: 10px; font-size: 0.85em; opacity: 0.9; text-align: left; }
        #answerKey .item { margin: 6px 0; line-height: 1.25; }
        #answerKey .ok { color: #10ff82; }
        #answerKey .bad { color: #ff6b6b; }
        #answerKey .tip { color: #66aaff; } /* correta quando o jogador erra */
        /* Botão de som discreto (bem menor) */
        .sound-toggle{
            font-size: .8em;
            padding: 6px 12px;
            border-radius: 16px;
            margin-top: 2px;
            background:#2a2a2a;
            box-shadow:none;
        }
        .sound-toggle:hover{ transform:none; box-shadow:none; }
        .sound-toggle::before{ display:none; }
        @media (max-width: 600px) {
            .container { width: 95%; padding: 10px; }
            .logo { font-size: 2em; }
            button { padding: 10px 20px; font-size: 1em; }
            .question-card h2 { font-size: 1.5em; }
            .question-card p { font-size: 1em; }
            .footer { font-size: 0.8em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="welcome">
            <h1 class="logo">BalbiQuiz</h1>
            <p>Bem-vindo ao mini RPG de HVAC! Teste seus conhecimentos em projetos e conceitos baseados nos manuais da ASHRAE.</p>
            <!-- Som discreto ACIMA do iniciar -->
            <button id="soundToggle" class="sound-toggle" aria-pressed="true">som: liga</button>
            <button onclick="startGame()">Iniciar Jogo</button>
        </div>

        <!-- Mesma estrutura, com 3 alternativas -->
        <div id="question1" class="question-card">
            <h2 id="title1"></h2>
            <p id="text1"></p>
            <p>Escolha a decisão:</p>
            <button id="opt1a" onclick="selectAnswer(1,'a')"></button>
            <button id="opt1b" onclick="selectAnswer(1,'b')"></button>
            <button id="opt1c" onclick="selectAnswer(1,'c')"></button>
            <button onclick="showHint(1)">Pedir Dica</button>
            <p class="hint" id="hint1"></p>
        </div>
        <div id="question2" class="question-card">
            <h2 id="title2"></h2>
            <p id="text2"></p>
            <p>Escolha a decisão:</p>
            <button id="opt2a" onclick="selectAnswer(2,'a')"></button>
            <button id="opt2b" onclick="selectAnswer(2,'b')"></button>
            <button id="opt2c" onclick="selectAnswer(2,'c')"></button>
            <button onclick="showHint(2)">Pedir Dica</button>
            <p class="hint" id="hint2"></p>
        </div>
        <div id="question3" class="question-card">
            <h2 id="title3"></h2>
            <p id="text3"></p>
            <p>Escolha a decisão:</p>
            <button id="opt3a" onclick="selectAnswer(3,'a')"></button>
            <button id="opt3b" onclick="selectAnswer(3,'b')"></button>
            <button id="opt3c" onclick="selectAnswer(3,'c')"></button>
            <button onclick="showHint(3)">Pedir Dica</button>
            <p class="hint" id="hint3"></p>
        </div>
        <div id="question4" class="question-card">
            <h2 id="title4"></h2>
            <p id="text4"></p>
            <p>Escolha a decisão:</p>
            <button id="opt4a" onclick="selectAnswer(4,'a')"></button>
            <button id="opt4b" onclick="selectAnswer(4,'b')"></button>
            <button id="opt4c" onclick="selectAnswer(4,'c')"></button>
            <button onclick="showHint(4)">Pedir Dica</button>
            <p class="hint" id="hint4"></p>
        </div>
        <div id="question5" class="question-card">
            <h2 id="title5"></h2>
            <p id="text5"></p>
            <p>Escolha a decisão:</p>
            <button id="opt5a" onclick="selectAnswer(5,'a')"></button>
            <button id="opt5b" onclick="selectAnswer(5,'b')"></button>
            <button id="opt5c" onclick="selectAnswer(5,'c')"></button>
            <button onclick="showHint(5)">Pedir Dica</button>
            <p class="hint" id="hint5"></p>
        </div>

        <div id="result">
            <h2>Resultado Final do BalbiQuiz</h2>
            <p class="score" id="scoreText">Pontuação: 0/100</p>
            <p class="pass-fail" id="passFail"></p>
            <!-- Gabarito pequeno da rodada -->
            <div id="answerKey"></div>
            <button onclick="restartGame()">Jogar Novamente</button>
        </div>
        <div class="footer">© 2025 BalbiQuiz. Construído com ❤️ para a comunidade cripto.</div>
    </div>

    <script>
        /* ========= ÁUDIO ========= */
        let audioCtx = null;
        let soundOn = true;
        function ensureAudio(){
            if(!audioCtx){
                try { audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
                catch(e){ /* ignora problemas de áudio */ }
            }
        }
        // Mesmo som para cliques de resposta/dica
        function tapSound(){
            if(!soundOn) return;
            try{
                ensureAudio();
                if(!audioCtx) return;
                const play = ()=>{
                    const o = audioCtx.createOscillator();
                    const g = audioCtx.createGain();
                    o.connect(g); g.connect(audioCtx.destination);
                    o.type = "sine"; o.frequency.value = 620;
                    const t0 = audioCtx.currentTime;
                    g.gain.setValueAtTime(0.001, t0);
                    g.gain.exponentialRampToValueAtTime(0.18, t0 + 0.01);
                    g.gain.exponentialRampToValueAtTime(0.001, t0 + 0.12);
                    o.start(t0); o.stop(t0 + 0.14);
                };
                if(audioCtx.state === "suspended"){ audioCtx.resume().then(play).catch(()=>{}); } else { play(); }
            }catch(e){ /* não interrompe o jogo */ }
        }
        // Som curto ao iniciar
        function startSound(){
            if(!soundOn) return;
            try{
                ensureAudio();
                if(!audioCtx) return;
                const play = ()=>{
                    const o = audioCtx.createOscillator();
                    const g = audioCtx.createGain();
                    o.connect(g); g.connect(audioCtx.destination);
                    o.type = "sine"; o.frequency.value = 520;
                    const t0 = audioCtx.currentTime;
                    g.gain.setValueAtTime(0.001, t0);
                    g.gain.exponentialRampToValueAtTime(0.15, t0 + 0.02);
                    g.gain.exponentialRampToValueAtTime(0.001, t0 + 0.10);
                    o.start(t0); o.stop(t0 + 0.12);
                };
                if(audioCtx.state === "suspended"){ audioCtx.resume().then(play).catch(()=>{}); } else { play(); }
            }catch(e){ /* ignora */ }
        }

        const soundBtn = document.getElementById('soundToggle');
        soundBtn.addEventListener('click', ()=>{
            soundOn = !soundOn;
            soundBtn.textContent = soundOn ? "som: liga" : "som: desliga";
            soundBtn.setAttribute('aria-pressed', soundOn ? 'true' : 'false');
            // não toca som aqui para não atrapalhar a primeira interação
        });

        /* ========= ESTADO ========= */
        const QUESTIONS_PER_ROUND = 5; // mantido
        let currentQuestion = 0;
        let score = 0;
        let hintsUsed = Array(5).fill(false);
        let selectedQuestions = [];
        const answersMap = {};             // mapa ok/err da UI
        const chosen = {};                 // registro de escolha do usuário
        const displayedOptionsText = {};   // textos exibidos por pergunta
        const correctTextMap = {};         // texto da correta exibida (para gabarito quando errar)

        // util
        const shuffle = (arr) => arr.map(v=>({v, r:Math.random()})).sort((a,b)=>a.r-b.r).map(e=>e.v);

        // referências curtas (aparecem aleatório em certas/erradas)
        const normRefs = [
            "ASHRAE 62.1-2019 §6.2",
            "ASHRAE 55-2020 §5.3",
            "ASHRAE 90.1-2019 §6.5",
            "ASHRAE 15-2019 §8",
            "ASHRAE TC 9.9 (Thermal Guidelines)",
            "NBR 16401-3:2008 §7",
            "NBR 15220-3 §5",
            "IEC 60079-13 §5.5"
        ];
        function maybeDecorateWithRef(text){
            if (Math.random() < 0.5) {
                const ref = normRefs[Math.floor(Math.random()*normRefs.length)];
                return `${text} — Ref: ${ref}`;
            }
            return text;
        }

        /* ====== BANCO DE QUESTÕES (24 itens, 3 alternativas) ====== */
        const questions = [
            { text: "Edifício comercial com ar abafado e odores persistentes. Ventilação mínima.",
              correct: "Elevar a ventilação externa e balancear o sistema para atender critérios adequados de IAQ.",
              wrong1: "Reduzir a renovação de ar para cortar consumo, mantendo o status atual.",
              wrong2: "Aplicar um critério de segurança de refrigerantes para decidir taxas mínimas de ventilação.",
              hint: "Ventilação adequada é determinante para IAQ." },
            { text: "Hospital com mofo por umidade alta; HVAC não controla UR.",
              correct: "Desumidificar e manter UR < 60% com controle dedicado no suprimento.",
              wrong1: "Elevar apenas o setpoint de temperatura e ignorar a UR.",
              wrong2: "Usar requisitos de eficiência energética para fixar um ponto de UR em área crítica.",
              hint: "Mofo = UR alta; trate a umidade diretamente." },
            { text: "Dutos superdimensionados geram distribuição irregular e ruídos.",
              correct: "Redimensionar dutos por método consagrado (p.ex., estática recuperada/SMACNA) e reequilibrar.",
              wrong1: "Instalar mais ventiladores em série sem revisar dutos.",
              wrong2: "Usar norma elétrica para definir bitola de duto de ar.",
              hint: "Métodos de dutos resolvem raiz do problema." },
            { text: "Escolha de refrigerante; opções incluem GWP alto.",
              correct: "Priorizar fluido de baixo GWP considerando segurança, eficiência e compatibilidades.",
              wrong1: "Escolher o maior GWP pelo menor CAPEX.",
              wrong2: "Usar um procedimento de ventilação de ocupação para aprovar refrigerante.",
              hint: "Sustentabilidade e conformidade contam." },
            { text: "Prédio alto com infiltração de ar externo indesejada.",
              correct: "Ajustar pressões para leve positivo em zonas limpas e melhorar estanqueidade.",
              wrong1: "Vedar janelas com fita sem revisar setpoints e balanceamento.",
              wrong2: "Definir pressões com base em limites de conforto térmico apenas.",
              hint: "Relação de pressão entre zonas é chave." },
            { text: "Data center com hotspot em racks por má distribuição.",
              correct: "Conter corredores quente/frio e otimizar percursos de ar, com vedação de vazios.",
              wrong1: "Aumentar rotação dos ventiladores apenas.",
              wrong2: "Usar requisitos de segurança de refrigerantes para layout de TI.",
              hint: "Fluxo organizado evita superaquecimento." },
            { text: "Escritório com desconforto por variações entre zonas.",
              correct: "Controle por zonas (p.ex., VAV comissionado) e difusão adequada.",
              wrong1: "Aumentar potência da máquina central para todo o andar.",
              wrong2: "Fixar um único sensor de retorno como referência de todo o pavimento.",
              hint: "Mais controle local = mais conforto." },
            { text: "Escola com filtros de baixa eficiência e IAQ comprometida.",
              correct: "Adotar MERV mais alto (p.ex., 13) e garantir vedação/assentamento corretos.",
              wrong1: "Diminuir a eficiência de filtragem para reduzir queda de pressão.",
              wrong2: "Usar um padrão de classificação de segurança de fluidos para definir MERV.",
              hint: "Filtragem adequada reduz partículas." },
            { text: "Vazamentos recorrentes de refrigerante em sistema industrial.",
              correct: "Programa de manutenção com detecção de vazamentos, registros e eliminação da causa.",
              wrong1: "Repor fluido periodicamente e seguir operando.",
              wrong2: "Aplicar critérios de ventilação mínima para definir vazamento aceitável.",
              hint: "Vazamento não é rotina: investigue." },
            { text: "Teatro com ruído de HVAC impactando a acústica.",
              correct: "Silenciadores em dutos, difusão adequada e velocidades controladas.",
              wrong1: "Elevar o fluxo para 'mascarar' ruído.",
              wrong2: "Usar um padrão residencial para metas acústicas de teatro.",
              hint: "Tratamento acústico no duto ajuda muito." },
            { text: "Câmara fria com consumo alto por isolamento precário.",
              correct: "Melhorar isolamento/vedações e revisar portas/cortinas de ar.",
              wrong1: "Aumentar a capacidade do compressor.",
              wrong2: "Usar diretrizes de conforto térmico para especificar painel frigorífico.",
              hint: "Perdas térmicas controladas = menor consumo." },
            { text: "Laboratório com ACH insuficiente para contaminantes voláteis.",
              correct: "Aumentar troca de ar e exaustão dedicada; avaliar capelas/capturas locais.",
              wrong1: "Perfumar o ambiente e manter ACH atual.",
              wrong2: "Usar normas de eficiência energética para definir exaustão mínima.",
              hint: "Segurança primeiro; exaustão específica." },
            { text: "Hotel com temperatura inconsistente entre quartos.",
              correct: "Termostatos por quarto/zona, balanceamento e conferência de válvulas/difusores.",
              wrong1: "Ajuste único de setpoint na central para todos.",
              wrong2: "Usar requisitos de ventilação para controlar setpoint do hóspede.",
              hint: "Controle individual melhora a experiência." },
            { text: "Shopping com odores persistentes de cozinhas.",
              correct: "Redimensionar exaustão de coifas/dutos/descarga e balancear pressões.",
              wrong1: "Aumentar apenas ventilação geral do mall.",
              wrong2: "Aplicar um padrão de segurança de fluidos para coifas comerciais.",
              hint: "Cozinha pede exaustão dedicada." },
            { text: "Ginásio com condensação em janelas por UR alta.",
              correct: "Desumidificar o suprimento e ajustar difusão/temperaturas.",
              wrong1: "Abrir mais ar externo sem tratar UR.",
              wrong2: "Usar norma de eficiência predial para fixar UR do ginásio.",
              hint: "Ataque a umidade; só ventilação pode não bastar." },
            { text: "Sala limpa requer partículas e pressão controladas.",
              correct: "Pressão diferencial positiva adequada e filtragem HEPA; vedações e portas corretas.",
              wrong1: "Empregar MERV 8 e portas abertas para 'maior ventilação'.",
              wrong2: "Usar padrão de segurança de fluidos para classe de limpeza de ar.",
              hint: "Pressão + filtragem = base." },
            { text: "Biblioteca com correntes frias sobre usuários.",
              correct: "Reposicionar difusores e reduzir velocidade terminal; difusão adequada.",
              wrong1: "Reduzir renovação de ar.",
              wrong2: "Usar norma de refrigeração de amônia para difusores.",
              hint: "Difusão correta evita 'draft'." },
            { text: "Salas de reunião com CO₂ elevado em pico.",
              correct: "Ventilação por demanda (CO₂) e balanceamento das taxas.",
              wrong1: "Elevar apenas o setpoint.",
              wrong2: "Usar padrão de segurança de fluidos para metas de CO₂.",
              hint: "DCV equilibra IAQ e energia." },
            { text: "Entrada térrea com infiltração pelo abre/fecha de portas.",
              correct: "Vestíbulo/cortina de ar e leve positivo interno; vedações funcionais.",
              wrong1: "Criar negativo interno para 'puxar' o ar externo.",
              wrong2: "Aplicar norma de segurança de fluidos para calcular infiltração.",
              hint: "Controle de fluxo na porta funciona." },
            { text: "Recepção com odores vindos de sanitários adjacentes.",
              correct: "Exaustão dedicada adequada e verificação de selos hidráulicos.",
              wrong1: "Perfumar e reduzir exaustão para economizar.",
              wrong2: "Usar conforto térmico para taxa de exaustão de banheiros.",
              hint: "Ambientes sujos pedem exaustão própria." },
            { text: "Auditório alto com estratificação térmica.",
              correct: "Destratificação/retorno alto e distribuição uniforme do suprimento.",
              wrong1: "Baixar setpoint geral sem mexer em difusão.",
              wrong2: "Usar ventilação mínima de ocupação para calcular altura do palco.",
              hint: "Trate a estratificação no projeto de ar." },
            { text: "Sala de TI pequena com hotspot em servidor.",
              correct: "Canalizar ar frio até o ponto e vedar vazios de passagem.",
              wrong1: "Instalar aquecedor para compensar diferenças.",
              wrong2: "Usar eficiência energética para posicionar racks.",
              hint: "Leve o ar onde precisa e vede." },
            { text: "Residência com odores do subsolo subindo pela escada.",
              correct: "Exaustão leve no subsolo, selar passagens e fechamento automático da porta.",
              wrong1: "Pressurizar negativamente a sala de estar.",
              wrong2: "Usar segurança de fluidos para taxa de exaustão de subsolos.",
              hint: "Gradiente de pressão bem pensado resolve." },
            { text: "Academia com ar 'pesado' após pico.",
              correct: "Aumentar ACH, melhorar filtragem e adotar ventilação por demanda.",
              wrong1: "Fechar tomadas de ar externo para economizar.",
              wrong2: "Usar padrão de segurança de fluidos para definir MERV da academia.",
              hint: "Carga bioefluente alta pede renovação/filtragem." }
        ];

        function startGame() {
            // não deixar nenhum problema de áudio travar o primeiro toque
            try { startSound(); } catch(e) {}
            document.getElementById('welcome').style.display = 'none';
            score = 0; currentQuestion = 0; hintsUsed = Array(5).fill(false);
            selectRandomQuestions();
            setupQuestions();
            nextQuestion();
        }

        function selectRandomQuestions() {
            selectedQuestions = [];
            const total = questions.length; // 24
            let indices = Array.from({length: total}, (_, i) => i);
            for (let i = 0; i < 5; i++) {
                const r = Math.floor(Math.random() * indices.length);
                selectedQuestions.push(indices.splice(r, 1)[0]);
            }
        }

        function setupQuestions() {
            for (let i = 0; i < 5; i++) {
                let questionNum = i + 1;
                let questionIndex = selectedQuestions[i];
                const q = questions[questionIndex];

                document.getElementById(`title${questionNum}`).innerText = `Situação ${questionNum}`;
                document.getElementById(`text${questionNum}`).innerText = q.text;
                document.getElementById(`hint${questionNum}`).innerText = q.hint || "";

                // 3 alternativas com chance de citar norma (tanto corretas quanto erradas)
                const optionObjs = [
                    { key: 'a', text: q.correct, ok: true },
                    { key: 'b', text: q.wrong1, ok: false },
                    { key: 'c', text: q.wrong2, ok: false }
                ].map(o => ({ ...o, text: maybeDecorateWithRef(o.text) }));

                const shuffled = shuffle(optionObjs);

                // mapa e textos exibidos
                answersMap[questionNum] = {};
                displayedOptionsText[questionNum] = { a: "", b: "", c: "" };

                // localizar texto da correta exibida (para gabarito)
                let correctShownText = "";

                const ids = [`opt${questionNum}a`, `opt${questionNum}b`, `opt${questionNum}c`];
                for (let k = 0; k < 3; k++) {
                    const btnId = ids[k];
                    const opt = shuffled[k];
                    const actualKey = ['a','b','c'][k];
                    document.getElementById(btnId).innerText = opt.text;
                    answersMap[questionNum][actualKey] = opt.ok;
                    displayedOptionsText[questionNum][actualKey] = opt.text;
                    if (opt.ok) correctShownText = opt.text;
                }
                correctTextMap[questionNum] = correctShownText;
            }
        }

        function nextQuestion() {
            currentQuestion++;
            if (currentQuestion <= 5) {
                let nextCard = document.getElementById(`question${currentQuestion}`);
                nextCard.style.display = 'block';
                nextCard.style.animation = 'fadeInDown 0.5s ease-in-out';
                setTimeout(() => { nextCard.style.animation = ''; }, 500);
            } else {
                showResult();
            }
        }

        function selectAnswer(questionNum, key) {
            const correct = !!(answersMap[questionNum] && answersMap[questionNum][key]);
            chosen[questionNum] = { key, text: displayedOptionsText[questionNum][key], correct };

            if (correct) { score += 20; }
            tapSound();

            let currentCard = document.getElementById(`question${questionNum}`);
            currentCard.style.animation = 'fadeOutUp 0.5s ease-in-out';
            setTimeout(() => {
                currentCard.style.display = 'none';
                currentCard.style.animation = '';
                nextQuestion();
            }, 500);
        }

        function showHint(question) {
            if (!hintsUsed[question - 1]) {
                document.getElementById(`hint${question}`).style.display = 'block';
                hintsUsed[question - 1] = true;
                tapSound();
            } else {
                alert('Você já usou sua dica para esta pergunta!');
            }
        }

        function showResult() {
            document.getElementById('result').style.display = 'block';
            document.getElementById('scoreText').innerText = `Pontuação: ${score}/100`;
            if (score >= 60) {
                document.getElementById('passFail').innerText = 'Você passou no Teste de Fogo de HVAC! Parabéns, Agente!';
                document.getElementById('passFail').style.color = '#00ff00';
            } else {
                document.getElementById('passFail').innerText = 'Você não passou. Estude mais os manuais ASHRAE!';
                document.getElementById('passFail').style.color = '#ff0000';
            }
            renderAnswerKey();
        }

        // Gabarito: mostra escolha; se errar, também mostra a correta em azul
        function renderAnswerKey(){
            const wrap = document.getElementById('answerKey');
            let html = '<h4 style="margin:8px 0 4px; opacity:.9">Gabarito desta rodada</h4>';
            html += '<div>';
            for (let i=1;i<=5;i++){
                if (!chosen[i]) continue;
                const cls = chosen[i].correct ? 'ok' : 'bad';
                html += `<div class="item"><strong>Q${i}:</strong> <span class="${cls}">${escapeHtml(chosen[i].text)}</span>`;
                if (!chosen[i].correct) {
                    html += `<div class="tip">Correta: ${escapeHtml(correctTextMap[i] || "")}</div>`;
                }
                html += `</div>`;
            }
            html += '</div>';
            wrap.innerHTML = html;
        }

        function escapeHtml(str){
            return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
        }

        function restartGame(){ location.reload(); }
    </script>
</body>
</html>
