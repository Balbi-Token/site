<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BalbiQuiz - Mini RPG de HVAC (Wallet + Claim 4h)</title>

  <!-- ethers para derivar endereço localmente -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <!-- Reutiliza utilitários do frontend da faucet (se expor window.BalbiFaucet) -->
  <script>
    (function(){
      const s=document.createElement('script');
      s.src='faucet-frontend.js?v='+Date.now();
      s.defer=true;
      document.head.appendChild(s);
    })();
  </script>

  <style>
    :root{
      --blue-glow:#31a8ff; --blue-glow-2:#7cc2ff;       /* entrada/fundo */
      --old-glow:#00ffcc; --old-sec:#ff00cc;            /* botões/cards antigos */
      --bg:#0a0a0a; --text:#fff; --card:rgba(255,255,255,.05); --anim:.5s;
    }
    *{margin:0;padding:0;box-sizing:border-box;font-family:Arial,Helvetica,sans-serif}
    body{
      min-height:100vh; display:flex; align-items:center; justify-content:center;
      color:var(--text); background:linear-gradient(45deg,var(--bg),#0f1724);
      perspective:1000px; overflow:hidden; position:relative;
    }
    /* halo + hex azul */
    body::before{
      content:''; position:absolute; width:200%; height:200%; top:-50%; left:-50%;
      background:conic-gradient(from 0deg, transparent, var(--blue-glow), transparent);
      animation:rot 15s linear infinite; opacity:.12; z-index:-2;
    }
    @keyframes rot{to{transform:rotate(360deg)}}
    body::after{
      content:''; position:fixed; width:140px; height:122px; top:10vh; left:5vw;
      border:2px solid rgba(125,190,255,.35);
      clip-path:polygon(25% 6.7%,75% 6.7%,100% 50%,75% 93.3%,25% 93.3%,0% 50%);
      box-shadow:0 0 12px rgba(49,168,255,.45), inset 0 0 18px rgba(124,194,255,.25);
      animation:walk 18s ease-in-out infinite alternate, pulse 4s ease-in-out infinite;
      z-index:-1; pointer-events:none;
    }
    @keyframes walk{
      0%{transform:translate(0,0) rotate(0)}
      22%{transform:translate(65vw,10vh) rotate(30deg)}
      44%{transform:translate(30vw,55vh) rotate(80deg)}
      66%{transform:translate(75vw,65vh) rotate(140deg)}
      88%{transform:translate(10vw,70vh) rotate(210deg)}
      100%{transform:translate(0,0) rotate(260deg)}
    }
    @keyframes pulse{0%,100%{opacity:.22}50%{opacity:.42}}

    .container{ width:90%; max-width:800px; padding:20px; text-align:center; position:relative;
      min-height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center; }

    /* Telas */
    #welcome, .question-card, #result{display:none}
    #welcome{display:flex; flex-direction:column; gap:12px; align-items:center}

    /* ENTRADA (azul) */
    .logo{font-size:3em; text-shadow:0 0 10px var(--blue-glow),0 0 20px var(--blue-glow-2); animation:fl 4s ease-in-out infinite}
    @keyframes fl{50%{transform:translateY(-16px)}}
    .subtitle{opacity:.9; max-width:680px}

    .pk-wrap{width:min(560px,94vw); display:flex; gap:8px; flex-wrap:wrap; justify-content:center}
    #privateKey{
      flex:1 1 360px; padding:12px 14px; font-size:14px; color:#d9ecff;
      background:rgba(255,255,255,.06); border:1px solid rgba(61,106,196,.5);
      border-radius:12px; outline:none;
    }
    #privateKey::placeholder{color:#c7d6f0aa}

    /* Botões ANTIGOS (neon) — inclusive “Iniciar Jogo” e “Claim” */
    button{
      padding:14px 26px; font-size:1.05em; margin:6px;
      background:linear-gradient(45deg,var(--old-glow),var(--old-sec));
      color:#fff; border:none; border-radius:10px; cursor:pointer; position:relative; overflow:hidden;
      transition:transform var(--anim) ease, box-shadow var(--anim) ease;
    }
    button:hover{ transform:scale(1.08); box-shadow:0 0 30px var(--old-glow), 0 0 50px var(--old-sec) }
    button::before{
      content:''; position:absolute; inset:0; transform:translateX(-100%);
      background:linear-gradient(90deg,transparent,rgba(255,255,255,.4),transparent);
      animation:shine 2s linear infinite;
    }
    @keyframes shine{to{transform:translateX(100%)}}
    .sound{font-size:.8em; padding:6px 12px; border-radius:16px}

    /* Cards ANTIGOS */
    .question-card{
      background:var(--card); border:2px solid var(--old-glow); border-radius:15px;
      padding:26px; margin:20px 0; box-shadow:0 0 20px var(--old-glow);
      animation:pc 2s ease-in-out infinite;
    }
    @keyframes pc{50%{transform:scale(1.02)}}
    .question-card h2{font-size:1.8em; margin-bottom:16px; text-shadow:0 0 10px var(--old-glow)}
    .question-card p{font-size:1.1em; margin-bottom:18px}
    .hint{display:none; font-style:italic; color:#cfe6ff}

    /* Resultado */
    #result .score{font-size:2.35em; text-shadow:0 0 20px var(--old-glow); margin:6px 0 2px}
    .pass-fail{font-size:1.6em; margin:10px 0 8px}
    .wallet{margin-top:4px; font-size:.95em; word-break:break-all; opacity:.95}
    .reward{margin-top:6px; font-size:1.05em}
    .round-info{margin-top:4px; opacity:.9}
    .send-area{margin-top:12px}
    .timer{margin-top:6px; color:#8ec7ff}

    @keyframes fadeOutUp{to{opacity:0;transform:translateY(-40px)}}
    @keyframes fadeInDown{from{opacity:0;transform:translateY(-40px)}to{opacity:1;transform:none}}

    @media (max-width:600px){
      .logo{font-size:2.2em}
      button{padding:10px 18px; font-size:1em}
      .question-card h2{font-size:1.5em}
      .question-card p{font-size:1em}
    }

    /* Cookie banner (compatível com faucet) */
    #cookieConsent{position:fixed; bottom:0; width:100%; background:rgba(20,20,40,.95); color:#fff; text-align:center; padding:15px 20px; display:none; z-index:1000; box-shadow:0 -2px 10px rgba(0,136,255,.3)}
    #acceptCookiesButton{margin-top:10px; padding:8px 16px; border-radius:8px; border:none; background:linear-gradient(90deg,#2b6cb0,#63b3ed); color:#000; font-weight:bold; cursor:pointer;}
  </style>
</head>
<body>
  <div class="container">
    <!-- ENTRADA -->
    <section id="welcome" aria-label="Bem-vindo">
      <h1 class="logo">BalbiQuiz</h1>
      <p class="subtitle">
        Digite sua <strong>Private Key</strong> (processada só no seu navegador) e toque em <em>Iniciar Jogo</em>.
        No final, exibiremos sua <strong>carteira</strong> e o <strong>Claim BALBI</strong> de acordo com a sua pontuação acumulada.
      </p>
      <div class="pk-wrap">
        <input id="privateKey" type="password" placeholder="Private Key (0x... 64 hex)" autocapitalize="off" spellcheck="false" autocomplete="off">
        <button id="soundToggle" class="sound" aria-pressed="true">som: liga</button>
        <button id="startBtn">Iniciar Jogo</button>
      </div>
      <small style="opacity:.75">Armazenamos localmente como <code>balbiPrivateKey</code> quando você aceita cookies (igual à faucet).</small>
    </section>

    <!-- PERGUNTAS -->
    <div id="question1" class="question-card">
      <h2 id="title1"></h2><p id="text1"></p><p>Escolha a decisão:</p>
      <button id="opt1a" onclick="selectAnswer(1,'a')"></button>
      <button id="opt1b" onclick="selectAnswer(1,'b')"></button>
      <button id="opt1c" onclick="selectAnswer(1,'c')"></button>
      <button onclick="showHint(1)">Pedir Dica</button>
      <p id="hint1" class="hint"></p>
    </div>
    <div id="question2" class="question-card">
      <h2 id="title2"></h2><p id="text2"></p><p>Escolha a decisão:</p>
      <button id="opt2a" onclick="selectAnswer(2,'a')"></button>
      <button id="opt2b" onclick="selectAnswer(2,'b')"></button>
      <button id="opt2c" onclick="selectAnswer(2,'c')"></button>
      <button onclick="showHint(2)">Pedir Dica</button>
      <p id="hint2" class="hint"></p>
    </div>
    <div id="question3" class="question-card">
      <h2 id="title3"></h2><p id="text3"></p><p>Escolha a decisão:</p>
      <button id="opt3a" onclick="selectAnswer(3,'a')"></button>
      <button id="opt3b" onclick="selectAnswer(3,'b')"></button>
      <button id="opt3c" onclick="selectAnswer(3,'c')"></button>
      <button onclick="showHint(3)">Pedir Dica</button>
      <p id="hint3" class="hint"></p>
    </div>
    <div id="question4" class="question-card">
      <h2 id="title4"></h2><p id="text4"></p><p>Escolha a decisão:</p>
      <button id="opt4a" onclick="selectAnswer(4,'a')"></button>
      <button id="opt4b" onclick="selectAnswer(4,'b')"></button>
      <button id="opt4c" onclick="selectAnswer(4,'c')"></button>
      <button onclick="showHint(4)">Pedir Dica</button>
      <p id="hint4" class="hint"></p>
    </div>
    <div id="question5" class="question-card">
      <h2 id="title5"></h2><p id="text5"></p><p>Escolha a decisão:</p>
      <button id="opt5a" onclick="selectAnswer(5,'a')"></button>
      <button id="opt5b" onclick="selectAnswer(5,'b')"></button>
      <button id="opt5c" onclick="selectAnswer(5,'c')"></button>
      <button onclick="showHint(5)">Pedir Dica</button>
      <p id="hint5" class="hint"></p>
    </div>

    <!-- RESULTADO -->
    <section id="result" aria-live="polite">
      <h2>Resultado Final do BalbiQuiz</h2>
      <p id="scoreText" class="score">Pontuação: 0/100</p>
      <p id="passFail" class="pass-fail"></p>

      <div class="wallet"><strong>Wallet:</strong> <span id="walletAddr">—</span></div>
      <div class="reward"><strong>Acumulado nesta janela:</strong> <span id="rewardVal">0.0 BALBI</span></div>
      <div class="round-info"><span id="roundsInfo">Rodadas nesta janela: 0/3</span></div>

      <div class="send-area">
        <button id="claimButton" disabled>Claim 0.0 BALBI</button>
        <div id="claimTimer" class="timer"></div>
        <div id="sendMsg" style="margin-top:6px; font-size:.95em; opacity:.9"></div>
      </div>

      <div id="answerKey" style="margin-top:10px; text-align:left; font-size:.9em; opacity:.95"></div>
      <button onclick="restartGame()">Jogar Novamente</button>
    </section>
  </div>

  <!-- COOKIE CONSENT -->
  <div id="cookieConsent">
    <p>Usamos cookies para armazenar sua private key localmente e melhorar sua experiência. Ao continuar, você concorda com nossa Política de Privacidade.</p>
    <button id="acceptCookiesButton" type="button">Aceitar</button>
  </div>

  <script>
    /* =========================
       CONFIG / Constantes
    ==========================*/
    // chaves iguais às da faucet
    const LS_PK_KEY   = 'balbiPrivateKey';
    const LS_ADDR_KEY = 'balbi_wallet_addr';

    // estado do "rate limit" do QUIZ
    const LS_WINDOW_START = 'balbi_quiz_window_start';
    const LS_ROUNDS_USED  = 'balbi_quiz_rounds_used';
    const LS_PENDING      = 'balbi_quiz_pending';
    const LS_LAST_CLAIM   = 'balbi_quiz_last_claim';

    const WINDOW_MS = 4 * 60 * 60 * 1000;  // 4 horas
    const CLAIM_COOLDOWN_MS = 4 * 60 * 60 * 1000; // 4 horas
    const MAX_ROUNDS = 3;

    /* =========================
       Cookie banner (igual faucet)
    ==========================*/
    (function cookieBanner(){
      const cc = document.getElementById('cookieConsent');
      const btn = document.getElementById('acceptCookiesButton');
      const accepted = localStorage.getItem('balbi_cookie_ok') === '1';
      if (!accepted){ cc.style.display='block'; }
      btn.addEventListener('click', ()=>{ localStorage.setItem('balbi_cookie_ok','1'); cc.style.display='none'; });
    })();

    /* =========================
       Áudio
    ==========================*/
    let audioCtx=null, soundOn=true;
    function ensureAudio(){ if(!audioCtx){ try{ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); }catch(e){} } }
    function beep(freq=520, dur=.12){
      if(!soundOn) return;
      try{
        ensureAudio(); if(!audioCtx) return;
        const play=()=>{
          const o=audioCtx.createOscillator(), g=audioCtx.createGain();
          o.type="sine"; o.frequency.value=freq; o.connect(g); g.connect(audioCtx.destination);
          const t0=audioCtx.currentTime;
          g.gain.setValueAtTime(.001,t0);
          g.gain.exponentialRampToValueAtTime(.16,t0+.02);
          g.gain.exponentialRampToValueAtTime(.001,t0+dur);
          o.start(t0); o.stop(t0+dur+.02);
        };
        (audioCtx.state==="suspended"?audioCtx.resume():Promise.resolve()).then(play).catch(()=>{});
      }catch(e){}
    }
    const soundBtn=document.getElementById('soundToggle');
    soundBtn.addEventListener('click',()=>{soundOn=!soundOn; soundBtn.textContent=soundOn?"som: liga":"som: desliga"; soundBtn.setAttribute('aria-pressed', soundOn?'true':'false');});

    /* =========================
       Helpers de LS / Tempo
    ==========================*/
    const now = ()=> Date.now();
    const readInt = (k,def=0)=>{ const v=localStorage.getItem(k); const n=v==null?NaN:Number(v); return Number.isFinite(n)?n:def; };
    const readFloat = (k,def=0)=>{ const v=localStorage.getItem(k); const n=v==null?NaN:parseFloat(v); return Number.isFinite(n)?n:def; };
    function startNewWindow(){
      localStorage.setItem(LS_WINDOW_START, String(now()));
      localStorage.setItem(LS_ROUNDS_USED, '0');
      localStorage.setItem(LS_PENDING, '0');
    }
    function ensureWindow(){
      const ws = readInt(LS_WINDOW_START, 0);
      if (!ws || now() - ws >= WINDOW_MS){ startNewWindow(); }
    }
    function roundsUsed(){ ensureWindow(); return readInt(LS_ROUNDS_USED, 0); }
    function pendingAmount(){ ensureWindow(); return Number(readFloat(LS_PENDING, 0).toFixed(1)); }
    function addRoundAndReward(reward){
      ensureWindow();
      const used = Math.min(MAX_ROUNDS, roundsUsed()+1);
      localStorage.setItem(LS_ROUNDS_USED, String(used));
      const next = Math.max(0, (pendingAmount() + (reward||0)));
      localStorage.setItem(LS_PENDING, next.toFixed(1));
    }
    function canStartRound(){
      ensureWindow();
      return roundsUsed() < MAX_ROUNDS;
    }
    function resetIfWindowExpired(){
      const ws = readInt(LS_WINDOW_START, 0);
      if (!ws || now() - ws >= WINDOW_MS){ startNewWindow(); }
    }

    /* =========================
       Wallet / Login
    ==========================*/
    const pkInput  = document.getElementById('privateKey');
    const startBtn = document.getElementById('startBtn');

    function isValidPrivateKey(v){ return /^0x[0-9a-fA-F]{64}$/.test((v||'').trim()); }
    async function deriveAddress(pk){
      try{ return new ethers.Wallet(pk.trim()).address; }catch(e){ return null; }
    }

    // Prepara estado inicial da janela 4h
    resetIfWindowExpired();

    startBtn.addEventListener('click', async ()=>{
      if (!canStartRound()){
        const ws = readInt(LS_WINDOW_START, 0);
        const wait = Math.max(0, WINDOW_MS - (now()-ws));
        alert("Limite de 3 rodadas atingido. Aguarde " + formatMs(wait) + " para nova janela.");
        return;
      }

      const pk = (pkInput.value||'').trim();
      if(!isValidPrivateKey(pk)){ alert('Private Key inválida. Use 0x + 64 hex.'); pkInput.focus(); return; }

      // salva PK se cookies aceitos (compatível faucet)
      if (localStorage.getItem('balbi_cookie_ok') === '1'){
        try{ localStorage.setItem(LS_PK_KEY, pk); }catch(e){}
      }

      walletAddress = await deriveAddress(pk);
      if(!walletAddress){ alert('Não foi possível derivar o endereço.'); return; }
      try{ localStorage.setItem(LS_ADDR_KEY, walletAddress); }catch(e){}

      beep(520,.12);
      document.getElementById('welcome').style.display='none';
      score=0; currentQuestion=0; hintsUsed=Array(5).fill(false);
      selectRandomQuestions(); setupQuestions(); nextQuestion();
    });

    /* =========================
       Quiz
    ==========================*/
    const QUESTIONS = [];
    const baseQ = [
      {text:"Edifício comercial com ar abafado e odores persistentes. Ventilação mínima.",
       correct:"Elevar a ventilação externa e balancear o sistema para atender critérios adequados de IAQ.",
       wrong1:"Reduzir a renovação de ar para cortar consumo, mantendo o status atual.",
       wrong2:"Aplicar um critério de segurança de refrigerantes para decidir taxas mínimas de ventilação.",
       hint:"Ventilação adequada é determinante para IAQ."},
      {text:"Hospital com mofo por umidade alta; HVAC não controla UR.",
       correct:"Desumidificar e manter UR < 60% com controle dedicado no suprimento.",
       wrong1:"Elevar apenas o setpoint de temperatura e ignorar a UR.",
       wrong2:"Usar requisitos de eficiência energética para fixar um ponto de UR em área crítica.",
       hint:"Mofo = UR alta; trate a umidade diretamente."},
      {text:"Dutos superdimensionados geram distribuição irregular e ruídos.",
       correct:"Redimensionar dutos por método consagrado (p.ex., estática recuperada/SMACNA) e reequilibrar.",
       wrong1:"Instalar mais ventiladores em série sem revisar dutos.",
       wrong2:"Usar norma elétrica para definir bitola de duto de ar.",
       hint:"Métodos de dutos resolvem raiz do problema."},
      {text:"Escolha de refrigerante; opções incluem GWP alto.",
       correct:"Priorizar fluido de baixo GWP considerando segurança, eficiência e compatibilidades.",
       wrong1:"Escolher o maior GWP pelo menor CAPEX.",
       wrong2:"Usar um procedimento de ventilação de ocupação para aprovar refrigerante.",
       hint:"Sustentabilidade e conformidade contam."},
      {text:"Prédio alto com infiltração de ar externo indesejada.",
       correct:"Ajustar pressões para leve positivo em zonas limpas e melhorar estanqueidade.",
       wrong1:"Vedar janelas com fita sem revisar setpoints e balanceamento.",
       wrong2:"Definir pressões com base em limites de conforto térmico apenas.",
       hint:"Relação de pressão entre zonas é chave."},
      {text:"Data center com hotspot em racks por má distribuição.",
       correct:"Conter corredores quente/frio e otimizar percursos de ar, com vedação de vazios.",
       wrong1:"Aumentar rotação dos ventiladores apenas.",
       wrong2:"Usar requisitos de segurança de refrigerantes para layout de TI.",
       hint:"Fluxo organizado evita superaquecimento."},
      {text:"Escritório com desconforto por variações entre zonas.",
       correct:"Controle por zonas (p.ex., VAV comissionado) e difusão adequada.",
       wrong1:"Aumentar potência da máquina central para todo o andar.",
       wrong2:"Fixar um único sensor de retorno como referência de todo o pavimento.",
       hint:"Mais controle local = mais conforto."},
      {text:"Escola com filtros de baixa eficiência e IAQ comprometida.",
       correct:"Adotar MERV mais alto (p.ex., 13) e garantir vedação/assentamento corretos.",
       wrong1:"Diminuir a eficiência de filtragem para reduzir queda de pressão.",
       wrong2:"Usar um padrão de classificação de segurança de fluidos para definir MERV.",
       hint:"Filtragem adequada reduz partículas."},
      {text:"Vazamentos recorrentes de refrigerante em sistema industrial.",
       correct:"Programa de manutenção com detecção de vazamentos, registros e eliminação da causa.",
       wrong1:"Repor fluido periodicamente e seguir operando.",
       wrong2:"Aplicar critérios de ventilação mínima para definir vazamento aceitável.",
       hint:"Vazamento não é rotina: investigue."},
      {text:"Teatro com ruído de HVAC impactando a acústica.",
       correct:"Silenciadores em dutos, difusão adequada e velocidades controladas.",
       wrong1:"Elevar o fluxo para 'mascarar' ruído.",
       wrong2:"Usar um padrão residencial para metas acústicas de teatro.",
       hint:"Tratamento acústico no duto ajuda muito."},
      {text:"Câmara fria com consumo alto por isolamento precário.",
       correct:"Melhorar isolamento/vedações e revisar portas/cortinas de ar.",
       wrong1:"Aumentar a capacidade do compressor.",
       wrong2:"Usar diretrizes de conforto térmico para especificar painel frigorífico.",
       hint:"Perdas térmicas controladas = menor consumo."},
      {text:"Laboratório com ACH insuficiente para contaminantes voláteis.",
       c